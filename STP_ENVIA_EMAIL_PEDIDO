create or replace PROCEDURE STP_ENVIA_EMAIL_PEDIDO(P_NUNOTA TGFCAB.NUNOTA%TYPE, P_STATUSPEDIDO AD_STATUSPEDIDO.STATUSPED%TYPE)
AS
   NumeroUnicoTMDFMG   TMDFMG.CODFILA%TYPE;
   NumeroUnicoTMDAMG   TMDAXM.NUANEXO%TYPE;

   CorpoEmail          CLOB := 'Mensagem';
   CorpoEmail_1          CLOB := 'Mensagem';
   
   V_NOMECONTATO        TGFCTT.NOMECONTATO%TYPE;
   V_NUMNOTA            VARCHAR2(40);
   V_STATUS             VARCHAR(100);
   V_EMAIL              TGFCTT.EMAIL%TYPE;
   V_COUNT  INT;
   V_ASSUNTO    VARCHAR2(100);
   V_CONTA_SMTP    int;
   V_CCO        VARCHAR2(100);
    V_TAM_FONTE     int;
    V_NUNOTA    INT;
    V_AD_NUNOTA    INT;
       pragma autonomous_transaction;
BEGIN
    SELECT COUNT(*) INTO V_COUNT FROM AD_STATUSPEDIDO WHERE STATUSPED=P_STATUSPEDIDO AND NUNOTA=P_NUNOTA;
    
    IF V_COUNT>0 THEN
        RETURN;
    END IF;
        
    BEGIN
        SELECT
            SMTP.CODSMTP INTO V_CONTA_SMTP 
        FROM 
            TSISMTP SMTP 
        WHERE 
            SMTP.AD_ENVIAEMAIL='S'
            and SMTP.PADRAO = 'S';
        
        SELECT
            TEXTO,
            NVL(CCO,'1'),
            TAMFONTE INTO CorpoEmail,V_CCO, V_TAM_FONTE
        FROM
            AD_CORPOEMAIL
        WHERE
            ID=1;
            
        SELECT 
            OPC.OPCAO INTO V_STATUS 
        FROM 
            TDDOPC OPC 
            JOIN TDDCAM CAM ON OPC.NUCAMPO=CAM.NUCAMPO 
        WHERE 
            NOMECAMPO='AD_STATUSPED' 
            AND VALOR=P_STATUSPEDIDO 
            AND AD_ENVIAEMAIL='S';
    
        CorpoEmail := REPLACE(CorpoEmail,'V_STATUS',V_STATUS);
        CorpoEmail := REPLACE(CorpoEmail,'11pt',V_TAM_FONTE||'pt');                

        IF INSTR(CorpoEmail,'V_NOMECONTATO_CAB')>0 THEN
            SELECT
                CTT.NOMECONTATO,
                CTT.EMAIL INTO V_NOMECONTATO, V_EMAIL
            FROM
                TGFCAB CAB 
                JOIN TGFCTT CTT ON CTT.CODPARC=CAB.CODPARC AND CTT.CODCONTATO=CAB.CODCONTATO AND CTT.AD_ENVIAEMAIL='S'
            WHERE
                CAB.NUNOTA=P_NUNOTA;
        ELSIF INSTR(CorpoEmail,'V_NOMECONTATO_PAR')>0 THEN
            SELECT
                CTT.NOMECONTATO,
                CTT.EMAIL INTO V_NOMECONTATO, V_EMAIL
            FROM
                TGFCAB CAB 
                JOIN TGFPAR PAR ON PAR.CODPARC=CAB.CODPARC 
                JOIN TGFCTT CTT ON CTT.CODPARC=PAR.CODPARC AND CTT.AD_ENVIAEMAIL='S'
            WHERE
                CAB.NUNOTA=P_NUNOTA 
                AND CTT.CODCONTATO=(SELECT MIN(C.CODCONTATO) FROM TGFCTT C WHERE C.CODPARC=CTT.CODPARC AND C.AD_ENVIAEMAIL='S');
        END IF;

        CorpoEmail := REPLACE(CorpoEmail,CASE WHEN INSTR(CorpoEmail,'V_NOMECONTATO_PAR')>0 THEN 'V_NOMECONTATO_PAR' ELSE 'V_NOMECONTATO_CAB' END,V_NOMECONTATO);
        
        SELECT
            NUMNOTA,NUNOTA, AD_NUNOTA INTO V_NUMNOTA, V_NUNOTA, V_AD_NUNOTA
        FROM
            TGFCAB CAB
        WHERE
            CAB.NUNOTA=P_NUNOTA;
        
        CorpoEmail := REPLACE(CorpoEmail,'V_NUMNOTA',V_NUMNOTA);           
        CorpoEmail := REPLACE(CorpoEmail,'V_NUNOTA',V_NUNOTA);
        CorpoEmail := REPLACE(CorpoEmail,'V_AD_NUNOTA',V_AD_NUNOTA);
        
        CorpoEmail := REPLACE(CorpoEmail,'V_DTALTER',TRUNC(SYSDATE));
                    
        CorpoEmail_1 :='<html xmlns="http://www.w3.org/1999/xhtml">
                                <head>
                                    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
                                    <meta name="viewport" content="width=device-width"/>
                                    
                                </head>
                                <body>
                                    <table class="body">
                                        <tr>
                                            <td class="center" align="center" valign="top">
                                            <center>
                                                <table class="container">
                                                    <tr>							
                                                        <td>
                                                            <table class="six columns">
                                                                <tr>
                                                                    <td align="center" valign="top">
                                                                        <center>
                                                                            <img src="http://trussprofessional.com/assinaturasis/cabe%C3%A7alho.jpeg" />
                                                                        </center>
                                                                    </td>
                                                                    <td class="expander"></td>
                                                                </tr>
                                                            </table>
                                                            <br>
                                                            <table class="row">
                                                                <tr>
                                                                    <td class="wrapper last">
                                                                        <table class="twelve columns">
                                                                            <tr>'||CorpoEmail||'</tr>
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                            <br>
                                                            <table class="row">
                                                                <tr>
                                                                    <td class="wrapper last">
                                                                        <table class="twelve columns">
                                                                            <tr>
                                                                                <td align="center" valign="top">
                                                                                    <center>
                                                                                    <img src="http://trussprofessional.com/assinaturasis/assinatura.jpeg" />
                                                                                    </center>
                                                                                </td>
                                                                                <td class="expander"></td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                            </table>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </center>
                                            </td>
                                        </tr>
                                    </table>
                                </body>
                            </html>';
        
        V_ASSUNTO:='PEDIDO '||V_NUNOTA||' - '||UPPER(V_STATUS); 

        SELECT 
            NVL (ULTCOD, 0) + 1
            INTO NumeroUnicoTMDFMG
        FROM 
            TGFNUM
        WHERE 
            ARQUIVO = 'TMDFMG'
            FOR UPDATE;

        BEGIN
            insert into TMDFMG (CODFILA, DTENTRADA, STATUS, CODCON, TENTENVIO,MENSAGEM, TIPOENVIO, MAXTENTENVIO, ASSUNTO, EMAIL, MIMETYPE, TIPODOC, CODUSU, NUCHAVE, REENVIAR, DBHASHCODE, CODSMTP)
            values(NumeroUnicoTMDFMG, sysdate, 'Pendente', 0, 1, CorpoEmail_1, 'E', 3, V_ASSUNTO , Replace(V_EMAIL, ';', ','), 'text/html', 'N', 0, 0, 'N', null,V_CONTA_SMTP);
            
        exception
            when OTHERS then
                raise_application_error(-20101, 'Erro: ' || sqlerrm);
        end;
        update TGFNUM set ULTCOD = NumeroUnicoTMDFMG where ARQUIVO = 'TMDFMG';
        commit;
                
        IF V_CCO<>'1' THEN
            SELECT 
                NVL (ULTCOD, 0) + 1
                INTO NumeroUnicoTMDFMG
            FROM 
                TGFNUM
            WHERE 
                ARQUIVO = 'TMDFMG'
                FOR UPDATE;

            BEGIN
                insert into TMDFMG (CODFILA, DTENTRADA, STATUS, CODCON, TENTENVIO,MENSAGEM, TIPOENVIO, MAXTENTENVIO, ASSUNTO, EMAIL, MIMETYPE, TIPODOC, CODUSU, NUCHAVE, REENVIAR, DBHASHCODE, CODSMTP)
                values(NumeroUnicoTMDFMG, sysdate, 'Pendente', 0, 1, CorpoEmail_1, 'E', 3, V_ASSUNTO , Replace(V_CCO, ';', ','), 'text/html', 'N', 0, 0, 'N', null,V_CONTA_SMTP);               
            exception
                when OTHERS then
                    raise_application_error(-20101, 'Erro: ' || sqlerrm);
            end;
            update TGFNUM set ULTCOD = NumeroUnicoTMDFMG where ARQUIVO = 'TMDFMG';
            commit;
        END IF;
    EXCEPTION WHEN NO_DATA_FOUND THEN
        RETURN;
    END;

end;
