create or replace PROCEDURE "AD_STP_CONTAS_RECEB_AGENDADO" (P_CODUSU NUMBER, -- Código do usuário logado
 P_IDISESSAO VARCHAR2, -- IDIentificador da execução. Serve para buscar informações dos parâmetros/campos da execução.
 P_QTDLINHAS NUMBER, -- Informa a quantIDIade de registros selecionados no momento da execução.
 P_MENSAGEM OUT VARCHAR2 -- Caso seja passada uma mensagem aqui, ela será exibIDIa como uma informação ao usuário.

) AS

V_NUFIN INT;
V_NUFIN1 INT;

BEGIN 
/*NOTAS DE VENDAS COM FINANCEIRO E VALORES DE ST*/
SELECT MAX(NUFIN)+1
INTO V_NUFIN
FROM AD_CONTASRECEB;

FOR FINANCEIRO IN (SELECT * FROM (SELECT CAB.CODPARC,
       CID.UF,
       CAB.NUMNOTA,
       CAB.CODEMP,
       CAB.DTNEG,
       CAB.DTNEG+TAB1.PRAZO AS VENC,
       CAB.VLRSUBST,
       /*VENDAS FRANQUEADOS DE SP*/
       CASE WHEN CID.UF = 1 AND PAR.CODTIPPARC = '10101001'
       THEN ROUND((CAB.VLRNOTA)/TAB.SEQ,2)

       /*VENDAS FRANQUEADOS FORA SP*/
       WHEN CID.UF <>1 AND PAR.CODTIPPARC = '10101001'
       THEN ROUND((CAB.VLRNOTA-CAB.VLRSUBST)/TAB.SEQ,2)

         /*VENDAS PERFIL VAREJO*/
         WHEN TPP.DESCRTIPPARC LIKE  '%VAREJO%' THEN
           ROUND((CAB.VLRNOTA)/TAB.SEQ,2)
           /*VENDAS ACADEMIA*/
           WHEN CAB.CODEMP = 7 AND CAB.CODTIPOPER = 3237 THEN
           ROUND((CAB.VLRNOTA/tab.seq),2)
           /*OUTROS VALORES*/
           else  
           ROUND((CAB.VLRNOTA/tab.seq),2)
                        END AS VLRNOTA1,


            TPP.DESCRTIPPARC,
       '1' as tipo,
        CAB.VLRNOTA,
       TAB1.SEQUENCIA as parcela,
          rownum,
          CAB.CODTIPOPER

FROM TGFCAB CAB, TGFPAR PAR, TGFTOP TOP, TSICID CID, TGFTPP TPP,
(SELECT CODTIPVENDA, SEQ FROM (SELECT CODTIPVENDA, COUNT(SEQUENCIA) AS SEQ FROM TGFPPG WHERE FORMULA NOT LIKE 'VLRSUBST'
GROUP BY CODTIPVENDA)) TAB,
(SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM (SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM TGFPPG)) TAB1

WHERE CAB.TIPMOV = 'V'
AND PAR.CODCID = CID.CODCID
AND TPP.CODTIPPARC = PAR.CODTIPPARC
AND TOP.GRUPO = 'Vendas'
AND TOP.BONIFICACAO = 'N'
AND TOP.ATUALFIN = 1
AND TOP.TIPATUALFIN = 'I'
and CAB.STATUSNOTA = 'L'
and PAR.CODTIPPARC NOT IN ('10101008')
AND CAB.CODTIPOPER = TOP.CODTIPOPER 
AND CAB.DHTIPOPER = TOP.DHALTER
AND CAB.CODPARC = PAR.CODPARC
and CAB.CODPARC NOT IN (1,2,3,5,6,7,8,9,3815)
AND CAB.CODTIPVENDA = TAB.CODTIPVENDA
AND CAB.CODTIPVENDA = TAB1.CODTIPVENDA
and CAB.dtneg = TRUNC(SYSDATE)
AND TAB1.FORMULA NOT LIKE 'VLRSUBST'




UNION ALL


/*BLOCO PARA INSERIR VALORES DE ST*/
SELECT CAB.CODPARC,
       CID.UF,
       CAB.NUMNOTA,
       CAB.CODEMP,
       CAB.DTNEG,
       CAB.DTNEG+TAB1.PRAZO AS VENC,
       CAB.VLRSUBST,
       CAB.VLRSUBST AS VLRNOTA1,
       TPP.DESCRTIPPARC,
       '4' as tipo,
     CAB.VLRNOTA,
       TAB1.SEQUENCIA as parcela,
          rownum,
          CAB.CODTIPOPER
FROM TGFCAB CAB, TGFPAR PAR, TGFTOP TOP, TSICID CID, TGFTPP TPP,
(SELECT CODTIPVENDA, SEQ FROM (SELECT CODTIPVENDA, COUNT(SEQUENCIA) AS SEQ FROM TGFPPG WHERE FORMULA LIKE 'VLRSUBST'
GROUP BY CODTIPVENDA)) TAB,
(SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM (SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM TGFPPG)) TAB1

WHERE CAB.TIPMOV = 'V'
AND PAR.CODCID = CID.CODCID
AND PAR.CODTIPPARC = TPP.CODTIPPARC
AND CID.UF NOT IN (1)
AND TOP.GRUPO = 'Vendas'
AND TOP.BONIFICACAO = 'N'
AND TOP.ATUALFIN = 1
AND TOP.TIPATUALFIN = 'I'
and CAB.STATUSNOTA = 'L'
AND CAB.CODTIPOPER = TOP.CODTIPOPER 
AND CAB.DHTIPOPER = TOP.DHALTER
AND CAB.CODPARC = PAR.CODPARC
AND PAR.CODTIPPARC = '10101001'
AND CAB.CODTIPVENDA = TAB.CODTIPVENDA
AND CAB.CODTIPVENDA = TAB1.CODTIPVENDA
and CAB.dtneg = TRUNC(SYSDATE)
AND TAB1.FORMULA LIKE 'VLRSUBST'
and CAB.CODPARC NOT IN (1,2,3,5,6,7,8,9,3815)
AND CAB.VLRSUBST >0)


ORDER BY NUMNOTA, PARCELA

)
LOOP
INSERT INTO AD_CONTASRECEB (NUFIN,CODPARC,NUMNOTA,CODEMP,DHEMISSAO,DTVENC,VLRDESDOB,VLRTOTAL, PARCELA,TIPO,IDK)
            VALUES (V_NUFIN+FINANCEIRO.ROWNUM,FINANCEIRO.CODPARC, FINANCEIRO.NUMNOTA,FINANCEIRO.CODEMP,FINANCEIRO.DTNEG,FINANCEIRO.VENC,FINANCEIRO.VLRNOTA1,FINANCEIRO.VLRNOTA,FINANCEIRO.PARCELA,FINANCEIRO.TIPO,300);
END LOOP;
COMMIT;



/*Devoluções de vendas*/
SELECT MAX(NUFIN)+1
INTO V_NUFIN1
FROM AD_CONTASRECEB;

FOR FINANCEIRO IN (SELECT * FROM (SELECT CAB.CODPARC,
       CID.UF,
       CAB.NUMNOTA,
       CAB.CODEMP,
       CAB.DTNEG,
       TAB2.DTNOTA+TAB1.PRAZO AS VENC,
       CAB.VLRSUBST,
       /*VENDAS FRANQUEADOS DE SP*/
       CASE WHEN CID.UF = 1 AND PAR.CODTIPPARC = '10101001'
       THEN ROUND((CAB.VLRNOTA)/TAB.SEQ,2)*-1

       /*VENDAS FRANQUEADOS FORA SP*/
       WHEN CID.UF <>1 AND PAR.CODTIPPARC = '10101001'
       THEN ROUND((CAB.VLRNOTA-CAB.VLRSUBST)/TAB.SEQ,2)*-1

         /*VENDAS PERFIL VAREJO*/
         WHEN TPP.DESCRTIPPARC LIKE  '%VAREJO%' THEN
           ROUND((CAB.VLRNOTA)/TAB.SEQ,2)*-1
          /*OUTROS VALORES*/
           else  
           ROUND((CAB.VLRNOTA/tab.seq),2)*-1
                        END AS VLRNOTA1,


            TPP.DESCRTIPPARC,
       '2' as tipo,
        CAB.VLRNOTA*-1 AS VLRNOTA,
       TAB1.SEQUENCIA as parcela,
          rownum,
          CAB.CODTIPOPER,
          tab2.dtnota

FROM TGFCAB CAB, TGFPAR PAR, TGFTOP TOP, TSICID CID, TGFTPP TPP,
(SELECT CODTIPVENDA, SEQ FROM (SELECT CODTIPVENDA, COUNT(SEQUENCIA) AS SEQ FROM TGFPPG WHERE FORMULA NOT LIKE 'VLRSUBST'
GROUP BY CODTIPVENDA)) TAB,
(SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM (SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM TGFPPG)) TAB1,
(SELECT dtnota,
          NUNOTAORIG,
          NUNOTA
   FROM
     (SELECT DISTINCT TGFCAB.DTNEG AS DTNOTA,
                      TGFVAR.NUNOTAORIG,
                      TGFVAR.NUNOTA
      FROM TGFCAB,
           TGFVAR
      WHERE TGFVAR.NUNOTAORIG = TGFCAB.NUNOTA))tab2

WHERE CAB.TIPMOV = 'D'
AND PAR.CODCID = CID.CODCID
AND TPP.CODTIPPARC = PAR.CODTIPPARC
AND TOP.GRUPO = 'Devolucao venda'
AND TOP.BONIFICACAO = 'N'
AND TOP.ATUALFIN = -1
AND TOP.TIPATUALFIN = 'I'
and CAB.STATUSNOTA = 'L'
and PAR.CODTIPPARC NOT IN ('10101008')
and tab2.nunota = cab.nunota
AND CAB.CODTIPOPER = TOP.CODTIPOPER 
AND CAB.DHTIPOPER = TOP.DHALTER
AND CAB.CODPARC = PAR.CODPARC
and CAB.CODPARC NOT IN (1,2,3,5,6,7,8,9,3815)
AND CAB.CODTIPVENDA = TAB.CODTIPVENDA
AND CAB.CODTIPVENDA = TAB1.CODTIPVENDA
and CAB.dtneg = trunc(sysdate)
AND TAB1.FORMULA NOT LIKE 'VLRSUBST')

UNION ALL

SELECT * FROM (SELECT CAB.CODPARC,
       CID.UF,
       CAB.NUMNOTA,
       CAB.CODEMP,
       CAB.DTNEG,
       TAB2.DTNOTA+TAB1.PRAZO AS VENC,
       CAB.VLRSUBST*-1,
       CAB.VLRSUBST*-1 AS VLRNOTA1,
       TPP.DESCRTIPPARC,
       '4' as tipo,
        CAB.VLRNOTA*-1 as VLRNOTA,
       TAB1.SEQUENCIA as parcela,
          rownum,
          CAB.CODTIPOPER,
          tab2.dtnota

FROM TGFCAB CAB, TGFPAR PAR, TGFTOP TOP, TSICID CID, TGFTPP TPP,
(SELECT CODTIPVENDA, SEQ FROM (SELECT CODTIPVENDA, COUNT(SEQUENCIA) AS SEQ FROM TGFPPG WHERE FORMULA LIKE 'VLRSUBST'
GROUP BY CODTIPVENDA)) TAB,
(SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM (SELECT CODTIPVENDA, SEQUENCIA, PRAZO, FORMULA FROM TGFPPG)) TAB1,
(SELECT dtnota,
          NUNOTAORIG,
          NUNOTA
   FROM
     (SELECT DISTINCT TGFCAB.DTNEG AS DTNOTA,
                      TGFVAR.NUNOTAORIG,
                      TGFVAR.NUNOTA
      FROM TGFCAB,
           TGFVAR
      WHERE TGFVAR.NUNOTAORIG = TGFCAB.NUNOTA))tab2

WHERE CAB.TIPMOV = 'D'
AND PAR.CODCID = CID.CODCID
AND TPP.CODTIPPARC = PAR.CODTIPPARC
AND TOP.GRUPO = 'Devolucao venda'
AND TOP.BONIFICACAO = 'N'
AND TOP.ATUALFIN = -1
AND CID.UF NOT IN (1)
AND TOP.TIPATUALFIN = 'I'
and CAB.STATUSNOTA = 'L'
and PAR.CODTIPPARC NOT IN ('10101008')
and tab2.nunota = cab.nunota
AND CAB.CODTIPOPER = TOP.CODTIPOPER 
AND CAB.DHTIPOPER = TOP.DHALTER
AND CAB.CODPARC = PAR.CODPARC
and CAB.CODPARC NOT IN (1,2,3,5,6,7,8,9,3815)
AND CAB.CODTIPVENDA = TAB.CODTIPVENDA
AND CAB.CODTIPVENDA = TAB1.CODTIPVENDA
and CAB.dtneg = trunc(sysdate)
AND TAB1.FORMULA LIKE 'VLRSUBST'))LOOP
INSERT INTO AD_CONTASRECEB (NUFIN,CODPARC,NUMNOTA,CODEMP,DHEMISSAO,DTVENC,VLRDESDOB,VLRTOTAL, PARCELA,TIPO,IDK)
            VALUES (V_NUFIN1+FINANCEIRO.ROWNUM,FINANCEIRO.CODPARC, FINANCEIRO.NUMNOTA,FINANCEIRO.CODEMP,FINANCEIRO.DTNEG,FINANCEIRO.VENC,FINANCEIRO.VLRNOTA1,FINANCEIRO.VLRNOTA,FINANCEIRO.PARCELA,FINANCEIRO.TIPO,301);
END LOOP;
COMMIT;



END;
